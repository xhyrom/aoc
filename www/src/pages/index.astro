---
import { getCollection } from "astro:content";
import { activeAocYear, yearsBetween } from "../lib/common.ts";
import Layout from "../layouts/Layout.astro";
import Container from "../components/Container.astro";

const series = await Promise.all(
  yearsBetween(2015, 2024).map(async (year) => {
    // @ts-expect-error fine
    const collection = await getCollection(`lb-${year}`);
    if (collection.length < 25) {
      for (let i = collection.length; i < 25; i++) {
        // @ts-expect-error fine
        collection.push({
          data: Array.from({ length: 100 }, (_, __) => ({
            time: {
              hours: null,
              minutes: null,
              seconds: null,
            },
          })),
        });
      }
    }

    return {
      name: year,
      data: collection.map((day) =>
        day.data[99].time.hours == null
          ? null
          : day.data[99].time.hours * 60 * 60 +
            day.data[99].time.minutes * 60 +
            day.data[99].time.seconds,
      ),
    };
  }),
);

const seriesEncoded = btoa(JSON.stringify(series));

const stats = (await getCollection("stats")).map((data) => ({
  name: data.id,
  data: data.data,
}));

const statsEncoded = btoa(JSON.stringify(stats));
---

<Layout>
  <Container class="pt-4 pb-4">
    <aoc-line-chart data-series={seriesEncoded} data-id="line-chart"
    ></aoc-line-chart>
    <aoc-heat-map-chart data-series={seriesEncoded} data-id="heat-chart"
    ></aoc-heat-map-chart>
    <aoc-bar-chart data-data={statsEncoded} data-id="bar-chart"></aoc-bar-chart>

    <main>
      <div>
        <p class="text-2xl font-bold">Leaderboard times</p>
        <p>
          Unofficial leaderboard times for the <a
            class="text-yellow-600"
            href="https://adventofcode.com">Advent of Code</a
          > challenges.
        </p>

        <div
          class="mt-4 mb-4 flex items-center gap-3 rounded-lg bg-amber-100 px-4 py-3 text-amber-800"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 20 20"
            fill="currentColor"
            class="w-5 h-5 flex-shrink-0 text-amber-600"
          >
            <path
              fill-rule="evenodd"
              d="M8.257 3.099c.746-1.29 2.74-1.29 3.486 0l6.518 11.276c.75 1.298-.213 2.925-1.742 2.925H3.48c-1.53 0-2.492-1.627-1.743-2.925L8.257 3.1zM9 7a1 1 0 012 0v4a1 1 0 11-2 0V7zm1 8a1.25 1.25 0 100-2.5A1.25 1.25 0 0010 15z"
              clip-rule="evenodd"></path>
          </svg>

          <p class="text-sm">
            Advent of Code removed the global leaderboard starting in <strong
              >2025</strong
            >, so global completion times can no longer be tracked (<a
              href="https://adventofcode.com/2025/about#faq_leaderboard"
              class="underline text-amber-700">learn more</a
            >).
          </p>
        </div>
      </div>

      <section>
        <div id="line-chart"></div>
      </section>

      <section>
        <div id="heat-chart"></div>
      </section>

      <section>
        <div>
          <p class="text-2xl font-bold">Stars</p>
          <p>
            You can see stars directly on the <a
              class="text-yellow-600"
              href="https://adventofcode.com">Advent of Code</a
            >. Stars are updated at 00:00 UTC and 8:00 UTC.
          </p>
          <p>
            Showing stars for the year <span id="year" class="text-yellow-600"
              >{activeAocYear()}</span
            >
          </p>

          <div id="bar-chart"></div>

          <div class="flex justify-center mt-4">
            <div class="flex flex-wrap justify-center">
              {
                yearsBetween(2015).map((year) => (
                  <button
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full mx-2 my-1"
                    onclick="document.querySelector('aoc-bar-chart').setAttribute('data-year', this.dataset.year); document.querySelector('#year').innerText = this.dataset.year;"
                    data-year={year}
                  >
                    {year}
                  </button>
                ))
              }
            </div>
          </div>
        </div>

        <script src="../lib/line_chart.ts"></script>
        <script src="../lib/heat_map_chart.ts"></script>
        <script src="../lib/bar_chart.ts"></script>
      </section>
    </main>
  </Container>
</Layout>
